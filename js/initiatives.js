// initiatives.js - –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤ –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É

// –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
const INITIATIVES_DATA = [
    {
        id: 1,
        title: "7 –¥–Ω–µ–π –±–µ–∑ –ø–ª–∞—Å—Ç–∏–∫–∞",
        category: "–û—Ç—Ö–æ–¥—ã",
        duration: "7 –¥–Ω–µ–π",
        difficulty: "–°—Ä–µ–¥–Ω—è—è",
        description: "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–µ–¥–µ–ª—é –æ–±—Ö–æ–¥–∏—Ç—å—Å—è –±–µ–∑ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –ø–ª–∞—Å—Ç–∏–∫–∞. –°—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø–æ–∫—É–ø–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤–æ–π –∏–ª–∏ –±–∏–æ—Ä–∞–∑–ª–∞–≥–∞–µ–º–æ–π —É–ø–∞–∫–æ–≤–∫–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–º –∏–∑–¥–µ–ª–∏—è–º. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ö–æ–¥–æ–≤ –∏ —Å–Ω–∏–∑–∏—Ç—å –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã. –ü—Ä–æ—Å—Ç—ã–µ —à–∞–≥–∏ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–æ–ª—å—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º!",
        checklist: [
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—É—é –±—É—Ç—ã–ª–∫—É",
            "–í–æ–∑—å–º–∏—Ç–µ —Å–≤–æ—é —Å—É–º–∫—É –≤ –º–∞–≥–∞–∑–∏–Ω",
            "–û—Ç–∫–∞–∂–∏—Ç–µ—Å—å –æ—Ç –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤",
            "–ö—É–ø–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ —Å—Ç–µ–∫–ª—è–Ω–Ω–æ–π —Ç–∞—Ä–µ",
            "–û—Ç–∫–∞–∂–∏—Ç–µ—Å—å –æ—Ç –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã—Ö —Å–æ–ª–æ–º–∏–Ω–æ–∫",
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã",
            "–°–¥–∞–π—Ç–µ –ø–ª–∞—Å—Ç–∏–∫ –Ω–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É"
        ],
        rewards: {
            ecoPoints: 150,
            badge: "–ì–µ—Ä–æ–π –±–µ–∑ –ø–ª–∞—Å—Ç–∏–∫–∞"
        },
        co2Reduction: 12,
        waterSaved: 50,
        image: "‚ôªÔ∏è"
    },
    {
        id: 2,
        title: "Zero Waste –Ω–∞ –∫—É—Ö–Ω–µ",
        category: "–û—Ç—Ö–æ–¥—ã",
        duration: "14 –¥–Ω–µ–π",
        difficulty: "–°–ª–æ–∂–Ω–∞—è",
        description: "–ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç–µ —Å–≤–æ—é –∫—É—Ö–Ω—é –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –±–µ–∑ –æ—Ç—Ö–æ–¥–æ–≤. –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø–æ–º–æ–≥—É—Ç —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–∞–∫–æ–≤–∫–∏, –ø—Ä–æ–¥–ª–∏—Ç—å —Å—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ —É–º–µ–Ω—å—à–∏—Ç—å –ø–∏—â–µ–≤—ã–µ –æ—Ç—Ö–æ–¥—ã.",
        checklist: [
            "–ü—Ä–æ–≤–µ–¥–∏—Ç–µ —Ä–µ–≤–∏–∑–∏—é –∫—É—Ö–æ–Ω–Ω—ã—Ö –∑–∞–ø–∞—Å–æ–≤ ‚Äî –æ—Ç–º–µ—Ç—å—Ç–µ, —á—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å",
            "–°–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –∏ –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é",
            "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–µ –º–µ—à–æ—á–∫–∏ –∏ —Å—É–º–∫–∏ –¥–ª—è –ø–æ–∫—É–ø–æ–∫",
            "–û—Ç–∫–∞–∂–∏—Ç–µ—Å—å –æ—Ç –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–π –ø–æ—Å—É–¥—ã –∏ —Å–∞–ª—Ñ–µ—Ç–æ–∫",
            "–ù–∞—á–Ω–∏—Ç–µ –∫–æ–º–ø–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ –æ—Ç—Ö–æ–¥—ã",
            "–ü–æ–∫—É–ø–∞–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã –±–µ–∑ —É–ø–∞–∫–æ–≤–∫–∏ (–Ω–∞ —Ä–∞–∑–≤–µ—Å) –∏–ª–∏ –≤ —Å—Ç–µ–∫–ª—è–Ω–Ω–æ–π —Ç–∞—Ä–µ",
            "–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Ç–µ –æ–±–µ–¥ –∏–∑ –æ—Å—Ç–∞—Ç–∫–æ–≤ ‚Äî –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø–∏—â–µ–≤—ã–µ –æ—Ç—Ö–æ–¥—ã"
        ],
        rewards: {
            ecoPoints: 300,
            badge: "–ú–∞—Å—Ç–µ—Ä Zero Waste"
        },
        co2Reduction: 25,
        waterSaved: 80,
        image: "‚ôªÔ∏è"
    },
    {
        id: 3,
        title: "–≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ –¥–æ–º–∞",
        category: "–≠–Ω–µ—Ä–≥–∏—è",
        duration: "5 –¥–Ω–µ–π",
        difficulty: "–õ–µ–≥–∫–∞—è",
        description: "–°–æ–∫—Ä–∞—â–∞–π—Ç–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏.",
        checklist: [
            "–ó–∞–º–µ–Ω–∏—Ç—å –ª–∞–º–ø—ã –Ω–∞ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–Ω—ã–µ",
            "–í—ã–∫–ª—é—á–∞—Ç—å —Å–≤–µ—Ç –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ",
            "–û—Ç–∫–ª—é—á–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫—É –Ω–∞ –Ω–æ—á—å",
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–≤–µ—Ç",
            "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–≥–∞—é—â–∏–π —Ä–µ–∂–∏–º"
        ],
        rewards: {
            ecoPoints: 100,
            badge: "–•—Ä–∞–Ω–∏—Ç–µ–ª—å —ç–Ω–µ—Ä–≥–∏–∏"
        },
        co2Reduction: 8,
        waterSaved: 30,
        image: "üí°"
    },
    {
        id: 4,
        title: "–≠–∫–æ–Ω–æ–º–∏—è –≤–æ–¥—ã",
        category: "–†–µ—Å—É—Ä—Å—ã",
        duration: "5 –¥–Ω–µ–π",
        difficulty: "–õ–µ–≥–∫–∞—è",
        description: "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ–º –≤–æ–¥—ã.",
        checklist: [
            "–ü—Ä–∏–Ω–∏–º–∞—Ç—å –¥—É—à –≤–º–µ—Å—Ç–æ –≤–∞–Ω–Ω—ã",
            "–í—ã–∫–ª—é—á–∞—Ç—å –≤–æ–¥—É –ø—Ä–∏ —á–∏—Å—Ç–∫–µ –∑—É–±–æ–≤",
            "–°–æ–±–∏—Ä–∞—Ç—å –¥–æ–∂–¥–µ–≤—É—é –≤–æ–¥—É",
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é –ø–æ—Å—É–¥–æ–º–æ–µ—á–Ω—É—é –º–∞—à–∏–Ω—É",
            "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–µ –Ω–∞—Å–∞–¥–∫–∏"
        ],
        rewards: {
            ecoPoints: 100,
            badge: "–≠–∫–æ–Ω–æ–º–Ω—ã–π –≤–æ–¥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        },
        co2Reduction: 5,
        waterSaved: 120,
        image: "üö∞"
    }
];

// ========== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–ù–ò–¶–ò–ê–¢–ò–í ==========
function renderInitiativeCard(initiative, progress, container) {
    const completedCount = progress?.completedTasks?.length || 0;
    const totalTasks = initiative.checklist.length;
    const percentage = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
    const isCompleted = progress?.completed === true;
    const isActive = progress?.started && !isCompleted;
    const startDate = progress?.startDate ? new Date(progress.startDate).toLocaleDateString('ru-RU') : null;
    
    const card = document.createElement('div');
    card.className = 'initiative-card';
    if (isCompleted) card.classList.add('initiative-card--completed');
    if (isActive) card.classList.add('initiative-card--active');
    card.setAttribute('data-id', initiative.id);
    
    card.innerHTML = `
        <div class="initiative-card__header">
            <div class="initiative-card__icon">${initiative.image}</div>
            <div class="initiative-card__title-wrapper">
                <h3 class="initiative-card__title">${initiative.title}</h3>
                <div class="initiative-card__meta">
                    <span class="initiative-card__meta-item">üìÖ ${initiative.duration}</span>
                    <span class="initiative-card__meta-item">üè∑Ô∏è ${initiative.category}</span>
                    <span class="initiative-card__meta-item">‚ö° ${initiative.difficulty}</span>
                </div>
            </div>
            ${isCompleted ? 
                '<div class="initiative-card__badge initiative-card__badge--completed">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>' : 
                isActive ? 
                '<div class="initiative-card__badge initiative-card__badge--active">üöÄ –í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>' : 
                ''
            }
        </div>
        
        <div class="initiative-card__content">
            <p class="initiative-card__description">${initiative.description}</p>
            
            ${isActive || isCompleted ? `
                <div class="initiative-card__progress">
                    <div class="initiative-card__progress-text">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å:</span>
                        <span>${completedCount}/${totalTasks}</span>
                    </div>
                    <div class="initiative-card__progress-bar">
                        <div class="initiative-card__progress-fill" style="width: ${percentage}%"></div>
                    </div>
                    ${startDate ? `<div class="initiative-card__date">–ù–∞—á–∞—Ç–æ: ${startDate}</div>` : ''}
                </div>
                
                <div class="initiative-card__impact">
                    <div class="initiative-card__impact-item">
                        <span class="initiative-card__impact-icon">üå±</span>
                        <span class="initiative-card__impact-text">+${initiative.rewards.ecoPoints} –±–∞–ª–ª–æ–≤</span>
                    </div>
                    <div class="initiative-card__impact-item">
                        <span class="initiative-card__impact-icon">üåç</span>
                        <span class="initiative-card__impact-text">‚àí${initiative.co2Reduction} –∫–≥ CO‚ÇÇ</span>
                    </div>
                    <div class="initiative-card__impact-item">
                        <span class="initiative-card__impact-icon">üíß</span>
                        <span class="initiative-card__impact-text">‚àí${initiative.waterSaved} –ª –≤–æ–¥—ã</span>
                    </div>
                </div>
            ` : ''}
            
            <div class="tasks-list" id="tasks-${initiative.id}">
                ${initiative.checklist.map((task, index) => {
                    const isTaskCompleted = progress?.completedTasks?.includes(index) || false;
                    const dayNumber = index + 1;
                    const canCheck = isActive && dayNumber <= (progress?.currentDay || 1);
                    
                    return `
                        <div class="task-item ${isTaskCompleted ? 'task-item--completed' : ''}" data-task-index="${index}">
                            <div class="task-item__day">–î–µ–Ω—å ${dayNumber}</div>
                            ${isActive || isCompleted ? `
                                <input type="checkbox" 
                                       class="task-item__checkbox" 
                                       data-id="${initiative.id}" 
                                       data-index="${index}"
                                       ${isTaskCompleted ? 'checked' : ''}
                                       ${!canCheck && !isTaskCompleted ? 'disabled' : ''}
                                       id="task-${initiative.id}-${index}">
                            ` : ''}
                            <label class="task-item__label" for="task-${initiative.id}-${index}">
                                ${task}
                                ${!canCheck && !isTaskCompleted && isActive ? 
                                    '<span class="task-item__lock">üîí</span>' : ''}
                            </label>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <div class="initiative-card__footer">
            <div class="initiative-card__rewards">
                <span class="rewards-icon">üèÜ</span>
                <span class="rewards-text">–ë–µ–π–¥–∂ "${initiative.rewards.badge}"</span>
            </div>
            <div class="initiative-card__actions">
                ${isCompleted ? 
                    `<button class="btn btn--small btn--completed" disabled>
                        <span>‚úÖ</span>
                        <span>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                    </button>` :
                    isActive ?
                    `<button class="btn btn--small btn--primary initiative-card__btn--continue" data-id="${initiative.id}">
                        <span>üìã</span>
                        <span>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</span>
                    </button>` :
                    `<button class="btn btn--small btn--primary initiative-card__btn--start" data-id="${initiative.id}">
                        <span>üéØ</span>
                        <span>–ù–∞—á–∞—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É</span>
                    </button>`
                }
            </div>
        </div>
    `;
    
    container.appendChild(card);
    return card;
}

function renderAllInitiatives() {
    const initiativesContainer = document.getElementById('initiativesContainer');
    const moreInitiativesContainer = document.getElementById('moreInitiativesContainer');
    
    if (!initiativesContainer || !moreInitiativesContainer) return;
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –µ–¥–∏–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
    const userData = window.dataManager?.userData || { initiatives: {} };
    
    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    initiativesContainer.innerHTML = '';
    moreInitiativesContainer.innerHTML = '';
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã: –∞–∫—Ç–∏–≤–Ω—ã–µ ‚Üí –Ω–∞—á–∞—Ç—ã–µ ‚Üí –Ω–µ –Ω–∞—á–∞—Ç—ã–µ
    const sortedInitiatives = [...INITIATIVES_DATA].sort((a, b) => {
        const progressA = userData.initiatives[a.id];
        const progressB = userData.initiatives[b.id];
        
        const isActiveA = progressA?.started && !progressA.completed;
        const isActiveB = progressB?.started && !progressB.completed;
        
        if (isActiveA && !isActiveB) return -1;
        if (!isActiveA && isActiveB) return 1;
        
        const isStartedA = progressA?.started;
        const isStartedB = progressB?.started;
        
        if (isStartedA && !isStartedB) return -1;
        if (!isStartedA && isStartedB) return 1;
        
        return 0;
    });
    
    // –ü–µ—Ä–≤—ã–µ 2 –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
    sortedInitiatives.slice(0, 2).forEach(initiative => {
        const userProgress = userData.initiatives[initiative.id];
        renderInitiativeCard(initiative, userProgress, initiativesContainer);
    });
    
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
    sortedInitiatives.slice(2).forEach(initiative => {
        const userProgress = userData.initiatives[initiative.id];
        renderInitiativeCard(initiative, userProgress, moreInitiativesContainer);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats();
}

// ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô ==========
function setupEventListeners() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ —á–µ–∫–±–æ–∫—Å–∞–º
    document.addEventListener('change', function(event) {
        if (event.target.classList.contains('task-item__checkbox')) {
            const initiativeId = parseInt(event.target.dataset.id);
            const taskIndex = parseInt(event.target.dataset.index);
            const isChecked = event.target.checked;
            
            handleTaskComplete(initiativeId, taskIndex, isChecked);
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ "–ù–∞—á–∞—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É"
    document.addEventListener('click', function(event) {
        const startBtn = event.target.closest('.initiative-card__btn--start');
        const continueBtn = event.target.closest('.initiative-card__btn--continue');
        
        if (startBtn) {
            const initiativeId = parseInt(startBtn.dataset.id);
            startInitiative(initiativeId);
        }
        
        if (continueBtn) {
            const initiativeId = parseInt(continueBtn.dataset.id);
            showInitiativeDetails(initiativeId);
        }
        
        // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
        const initiativeCard = event.target.closest('.initiative-card');
        if (initiativeCard && !event.target.closest('button') && !event.target.closest('input')) {
            const initiativeId = parseInt(initiativeCard.dataset.id);
            showInitiativeDetails(initiativeId);
        }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    document.addEventListener('ecodata-updated', function() {
        renderAllInitiatives();
        updateStats();
    });

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ - –ó–∞–∫—Ä—ã—Ç–∏–µ
    const modal = document.getElementById('initiativeModal');
    const closeBtn = document.getElementById('modalInitiativeClose');
    
    function closeInitiativeModal() {
        if (modal) {
            modal.setAttribute('aria-hidden', 'true');
        }
    }

    if (closeBtn) {
        closeBtn.addEventListener('click', closeInitiativeModal);
    }

    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeInitiativeModal();
            }
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && modal.getAttribute('aria-hidden') === 'false') {
            closeInitiativeModal();
        }
    });
}

function handleTaskComplete(initiativeId, taskIndex, isChecked) {
    if (!isChecked) return; // –ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ—á–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    
    if (!window.dataManager) {
        console.error('DataManager –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–∞–Ω–Ω—ã—Ö
    const result = window.dataManager.completeTask(initiativeId, taskIndex);
    
    if (result) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification(
            result.isCompleted ? 
            `üéâ –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! +${result.initiativePoints} –±–∞–ª–ª–æ–≤` :
            `‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! +10 –±–∞–ª–ª–æ–≤`
        );
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        updateCardProgress(initiativeId);
    }
}

function startInitiative(initiativeId) {
    const initiative = INITIATIVES_DATA.find(i => i.id === initiativeId);
    if (!initiative || !window.dataManager) return;
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–∞–Ω–Ω—ã—Ö
    const result = window.dataManager.startInitiative(initiative);
    
    if (result) {
        showNotification(`üéØ –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ "${initiative.title}" –Ω–∞—á–∞—Ç–∞!`);
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
        renderAllInitiatives();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        setTimeout(() => showInitiativeDetails(initiativeId), 300);
    }
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï UI ==========
function updateCardProgress(initiativeId) {
    if (!window.dataManager) return;
    
    const initiative = INITIATIVES_DATA.find(i => i.id === initiativeId);
    const progress = window.dataManager.userData.initiatives[initiativeId];
    
    if (!initiative || !progress) return;
    
    const completedCount = progress.completedTasks?.length || 0;
    const totalTasks = initiative.checklist.length;
    const percentage = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
    const isCompleted = progress.completed === true;
    const isActive = progress.started && !isCompleted;
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —ç—Ç–∏–º id
    const cards = document.querySelectorAll(`.initiative-card[data-id="${initiativeId}"]`);
    
    cards.forEach(card => {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        const progressText = card.querySelector('.initiative-card__progress-text span:last-child');
        const progressFill = card.querySelector('.initiative-card__progress-fill');
        
        if (progressText) progressText.textContent = `${completedCount}/${totalTasks}`;
        if (progressFill) progressFill.style.width = `${percentage}%`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å (BEM-–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã)
        card.classList.remove('initiative-card--completed', 'initiative-card--active');
        if (isCompleted) card.classList.add('initiative-card--completed');
        if (isActive) card.classList.add('initiative-card--active');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂
        const badgeContainer = card.querySelector('.initiative-card__header');
        let badge = card.querySelector('.initiative-card__badge');
        
        if (!badge && badgeContainer) {
            badge = document.createElement('div');
            badge.className = 'initiative-card__badge';
            badgeContainer.appendChild(badge);
        }
        
        if (badge) {
            if (isCompleted) {
                badge.className = 'initiative-card__badge initiative-card__badge--completed';
                badge.innerHTML = '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ';
            } else if (isActive) {
                badge.className = 'initiative-card__badge initiative-card__badge--active';
                badge.innerHTML = 'üöÄ –í –ø—Ä–æ—Ü–µ—Å—Å–µ';
            } else {
                badge.remove();
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
        const actionsContainer = card.querySelector('.initiative-card__actions');
        if (actionsContainer) {
            actionsContainer.innerHTML = isCompleted ? 
                `<button class="btn btn--small btn--completed" disabled>
                    <span>‚úÖ</span>
                    <span>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                </button>` :
                isActive ?
                `<button class="btn btn--small btn--primary initiative-card__btn--continue" data-id="${initiativeId}">
                    <span>üìã</span>
                    <span>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</span>
                </button>` :
                `<button class="btn btn--small btn--primary initiative-card__btn--start" data-id="${initiativeId}">
                    <span>üéØ</span>
                    <span>–ù–∞—á–∞—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É</span>
                </button>`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
        const checkboxes = card.querySelectorAll('.task-item__checkbox');
        checkboxes.forEach((checkbox, index) => {
            const isTaskCompleted = progress.completedTasks?.includes(index) || false;
            const canCheck = isActive && (index + 1) <= (progress.currentDay || 1);
            
            checkbox.checked = isTaskCompleted;
            checkbox.disabled = !canCheck && !isTaskCompleted;
            
            const taskItem = checkbox.closest('.task-item');
            const lockElement = taskItem?.querySelector('.task-item__lock');
            
            if (taskItem) {
                if (isTaskCompleted) {
                    taskItem.classList.add('task-item--completed');
                } else {
                    taskItem.classList.remove('task-item--completed');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–º–æ–∫
                if (lockElement) {
                    lockElement.style.display = !canCheck && !isTaskCompleted ? 'inline' : 'none';
                }
            }
        });
    });
}

function updateStats() {
    if (!window.dataManager) return;
    
    const stats = window.dataManager.getDashboardStats();
    const userData = window.dataManager.userData;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º DOM
    const completedTasksEl = document.getElementById('completedTasks');
    const completedInitiativesEl = document.getElementById('completedInitiatives');
    const ecoPointsEl = document.getElementById('ecoPoints');
    
    if (completedTasksEl) completedTasksEl.textContent = 
        `${stats.overallStats.completedTasks}/${stats.overallStats.totalTasks}`;
    
    if (completedInitiativesEl) completedInitiativesEl.textContent = 
        stats.overallStats.completedInitiatives;
    
    if (ecoPointsEl) ecoPointsEl.textContent = userData.ecoPoints;
    
    return stats;
}

// ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ò–ù–ò–¶–ò–ê–¢–ò–í–´ ==========
function showInitiativeDetails(initiativeId) {
    const initiative = INITIATIVES_DATA.find(i => i.id === initiativeId);
    const progress = window.dataManager?.userData?.initiatives?.[initiativeId];
    
    if (!initiative) return;
    
    const modal = document.getElementById('initiativeModal');
    if (!modal) return;
    
    const completedCount = progress?.completedTasks?.length || 0;
    const totalTasks = initiative.checklist.length;
    const percentage = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
    const isCompleted = progress?.completed === true;
    const isActive = progress?.started && !isCompleted;
    const startDate = progress?.startDate ? 
        new Date(progress.startDate).toLocaleDateString('ru-RU', { 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        }) : null;
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('modalInitiativeTitle').textContent = initiative.title;
    
    // –ë–µ–π–¥–∂–∏
    const badgesContainer = document.getElementById('modalInitiativeBadges');
    badgesContainer.innerHTML = `
        <span class="modal__badge modal__badge--category">${initiative.category}</span>
        <span class="modal__badge modal__badge--date">üìÖ ${initiative.duration}</span>
        <span class="modal__badge modal__badge--difficulty">‚ö° ${initiative.difficulty}</span>
        ${isCompleted ? '<span class="modal__badge modal__badge--completed">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>' : ''}
        ${isActive ? '<span class="modal__badge modal__badge--active">üöÄ –í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>' : ''}
    `;
    
    // –ü—Ä–æ–≥—Ä–µ—Å—Å
    const progressContainer = document.getElementById('modalInitiativeProgress');
    if (isActive || isCompleted) {
        progressContainer.innerHTML = `
            <div class="modal__progress-info">
                <div class="modal__progress-text">
                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: ${completedCount}/${totalTasks} –∑–∞–¥–∞—á</span>
                    <span class="modal__progress-percent">${percentage}%</span>
                </div>
                <div class="modal__progress-bar">
                    <div class="modal__progress-fill" style="width: ${percentage}%"></div>
                </div>
                ${startDate ? `<div class="modal__progress-date">–ù–∞—á–∞—Ç–æ: ${startDate}</div>` : ''}
            </div>
        `;
    } else {
        progressContainer.innerHTML = '';
    }
    
    // –û–ø–∏—Å–∞–Ω–∏–µ
    document.getElementById('modalInitiativeDescription').innerHTML = `
        <p>${initiative.description}</p>
    `;
    
    // –≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –≤–ª–∏—è–Ω–∏–µ
    const impactContainer = document.getElementById('modalInitiativeImpact');
    impactContainer.innerHTML = `
        <div class="modal__impact-item">
            <div class="modal__impact-icon">üå±</div>
            <div class="modal__impact-content">
                <div class="modal__impact-value">+${initiative.rewards.ecoPoints}</div>
                <div class="modal__impact-label">–≠–∫–æ-–±–∞–ª–ª–æ–≤</div>
            </div>
        </div>
        <div class="modal__impact-item">
            <div class="modal__impact-icon">üåç</div>
            <div class="modal__impact-content">
                <div class="modal__impact-value">‚àí${initiative.co2Reduction} –∫–≥</div>
                <div class="modal__impact-label">CO‚ÇÇ</div>
            </div>
        </div>
        <div class="modal__impact-item">
            <div class="modal__impact-icon">üíß</div>
            <div class="modal__impact-content">
                <div class="modal__impact-value">‚àí${initiative.waterSaved} –ª</div>
                <div class="modal__impact-label">–í–æ–¥—ã</div>
            </div>
        </div>
    `;
    
    // –ß–µ–∫–ª–∏—Å—Ç
    const checklistContainer = document.getElementById('modalInitiativeChecklist');
    checklistContainer.innerHTML = initiative.checklist.map((task, index) => {
        const isTaskCompleted = progress?.completedTasks?.includes(index) || false;
        const dayNumber = index + 1;
        const canCheck = isActive && dayNumber <= (progress?.currentDay || 1);
        
        return `
            <div class="modal__checklist-item ${isTaskCompleted ? 'modal__checklist-item--completed' : ''}">
                <input type="checkbox" 
                       class="modal__checklist-checkbox" 
                       data-id="${initiative.id}" 
                       data-index="${index}"
                       id="modal-task-${initiative.id}-${index}"
                       ${isTaskCompleted ? 'checked' : ''}
                       ${!canCheck && !isTaskCompleted ? 'disabled' : ''}>
                <label for="modal-task-${initiative.id}-${index}" class="modal__checklist-label">
                    <span class="modal__checklist-day">–î–µ–Ω—å ${dayNumber}</span>
                    <span class="modal__checklist-text">${task}</span>
                    ${!canCheck && !isTaskCompleted && isActive ? 
                        '<span class="modal__checklist-lock">üîí</span>' : ''}
                </label>
            </div>
        `;
    }).join('');
    
    // –ù–∞–≥—Ä–∞–¥—ã
    const rewardsContainer = document.getElementById('modalInitiativeRewards');
    rewardsContainer.innerHTML = `
        <div class="modal__rewards-item">
            <span class="modal__rewards-icon">üèÜ</span>
            <div class="modal__rewards-content">
                <div class="modal__rewards-badge">${initiative.rewards.badge}</div>
                <div class="modal__rewards-points">+${initiative.rewards.ecoPoints} –±–∞–ª–ª–æ–≤</div>
            </div>
        </div>
    `;
    
    // –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
    const actionBtn = document.getElementById('modalInitiativeAction');
    if (isCompleted) {
        actionBtn.innerHTML = '<span>‚úÖ</span> –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
        actionBtn.disabled = true;
        actionBtn.className = 'btn btn--secondary modal__action-btn';
        actionBtn.onclick = null;
    } else if (isActive) {
        actionBtn.innerHTML = '<span>üìã</span> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É';
        actionBtn.disabled = false;
        actionBtn.className = 'btn btn--primary modal__action-btn';
        actionBtn.onclick = () => {
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            updateCardProgress(initiativeId);
            // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modal.setAttribute('aria-hidden', 'true');
            // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤
            renderAllInitiatives();
        };
    } else {
        actionBtn.innerHTML = '<span>üéØ</span> –ù–∞—á–∞—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É';
        actionBtn.disabled = false;
        actionBtn.className = 'btn btn--primary modal__action-btn';
        actionBtn.onclick = () => {
            startInitiative(initiativeId);
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            setTimeout(() => {
                showInitiativeDetails(initiativeId);
            }, 300);
        };
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ–∫–±–æ–∫—Å–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    checklistContainer.querySelectorAll('.modal__checklist-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                const initiativeId = parseInt(this.dataset.id);
                const taskIndex = parseInt(this.dataset.index);
                handleTaskComplete(initiativeId, taskIndex, true);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                setTimeout(() => {
                    showInitiativeDetails(initiativeId);
                }, 300);
            }
        });
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (inline panel)
    modal.setAttribute('aria-hidden', 'false');
}

function showNotification(message) {
    const toast = document.createElement('div');
    toast.className = 'notification';
    toast.innerHTML = `
        <div class="notification__icon">üéØ</div>
        <div class="notification__content">${message}</div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('notification--hiding');
        setTimeout(() => {
            if (toast.parentNode) document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
function initApp() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º data-manager –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if (!window.dataManager) {
        console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º DataManager...');
        const script = document.createElement('script');
        // –ó–∞–≥—Ä—É–∂–∞–µ–º DataManager –∏–∑ –ø–∞–ø–∫–∏ eco-platform/js
        script.src = 'js/data-manager.js';
        script.onload = function() {
            console.log('DataManager –∑–∞–≥—Ä—É–∂–µ–Ω');
            initAfterDataManager();
        };
        document.head.appendChild(script);
    } else {
        initAfterDataManager();
    }
}

function initAfterDataManager() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
    renderAllInitiatives();
    setupEventListeners();
    updateStats();
    
    console.log('–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å DataManager');
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
window.initApp = initApp;
window.INITIATIVES_DATA = INITIATIVES_DATA;
window.getActiveInitiatives = function() {
    return window.dataManager ? window.dataManager.getActiveInitiatives() : [];
};

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
} else {
    initApp();
}

